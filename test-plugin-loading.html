<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•æ’ä»¶åŠ è½½</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-result { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow: auto; }
    </style>
</head>
<body>
    <h1>LifeBox æ’ä»¶ç³»ç»Ÿæµ‹è¯•</h1>

    <div id="test-results"></div>

    <h2>æµ‹è¯•æ—¥å¿—</h2>
    <pre id="test-log"></pre>

    <script>
        const log = (message, type = 'info') => {
            const logElement = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;

            const resultsElement = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = message;
            resultsElement.appendChild(resultDiv);
        };

        // æµ‹è¯•å…¨å±€APIæ˜¯å¦å¯ç”¨
        function testGlobalAPI() {
            log('æµ‹è¯•å…¨å±€API...', 'info');

            if (window.LifeBoxAPI) {
                log('âœ… å…¨å±€APIå¯ç”¨', 'success');

                // æµ‹è¯•APIç»„ä»¶
                const { React, components, utils } = window.LifeBoxAPI;

                if (React) log('âœ… Reactå¯ç”¨', 'success');
                else log('âŒ Reactä¸å¯ç”¨', 'error');

                if (components && components.Button) log('âœ… Buttonç»„ä»¶å¯ç”¨', 'success');
                else log('âŒ Buttonç»„ä»¶ä¸å¯ç”¨', 'error');

                if (utils && utils.cn) log('âœ… cnå·¥å…·å‡½æ•°å¯ç”¨', 'success');
                else log('âŒ cnå·¥å…·å‡½æ•°ä¸å¯ç”¨', 'error');

                return true;
            } else {
                log('âŒ å…¨å±€APIä¸å¯ç”¨', 'error');
                return false;
            }
        }

        // æµ‹è¯•æ’ä»¶manifestè®¿é—®
        async function testPluginManifest() {
            log('æµ‹è¯•æ’ä»¶manifestè®¿é—®...', 'info');

            try {
                const response = await fetch('/plugins/simple-test-plugin/manifest.json');
                if (response.ok) {
                    const manifest = await response.json();
                    log(`âœ… æ’ä»¶manifeståŠ è½½æˆåŠŸ: ${manifest.name}`, 'success');
                    return manifest;
                } else {
                    log(`âŒ æ’ä»¶manifeståŠ è½½å¤±è´¥: ${response.status}`, 'error');
                    return null;
                }
            } catch (error) {
                log(`âŒ æ’ä»¶manifestè®¿é—®é”™è¯¯: ${error.message}`, 'error');
                return null;
            }
        }

        // æµ‹è¯•æ’ä»¶è„šæœ¬åŠ è½½
        async function testPluginScript() {
            log('æµ‹è¯•æ’ä»¶è„šæœ¬åŠ è½½...', 'info');

            try {
                const response = await fetch('/plugins/simple-test-plugin/plugin.js');
                if (response.ok) {
                    const script = await response.text();
                    log(`âœ… æ’ä»¶è„šæœ¬è·å–æˆåŠŸ (${script.length} å­—ç¬¦)`, 'success');
                    return script;
                } else {
                    log(`âŒ æ’ä»¶è„šæœ¬åŠ è½½å¤±è´¥: ${response.status}`, 'error');
                    return null;
                }
            } catch (error) {
                log(`âŒ æ’ä»¶è„šæœ¬è®¿é—®é”™è¯¯: ${error.message}`, 'error');
                return null;
            }
        }

        // æ‰‹åŠ¨åŠ è½½æ’ä»¶è¿›è¡Œæµ‹è¯•
        async function loadTestPlugin() {
            log('æ‰‹åŠ¨åŠ è½½æµ‹è¯•æ’ä»¶...', 'info');

            try {
                const script = document.createElement('script');
                script.src = '/plugins/simple-test-plugin/plugin.js';
                script.onload = () => {
                    log('âœ… æ’ä»¶è„šæœ¬åŠ è½½å®Œæˆ', 'success');

                    // æ£€æŸ¥æ’ä»¶æ˜¯å¦æ³¨å†ŒæˆåŠŸ
                    if (window.LifeBoxPlugins && window.LifeBoxPlugins['simple-test-plugin']) {
                        log('âœ… æ’ä»¶æ³¨å†ŒæˆåŠŸ', 'success');

                        if (window.SimpleTestPlugin) {
                            log('âœ… æ’ä»¶å®ä¾‹åˆ›å»ºæˆåŠŸ', 'success');
                        } else {
                            log('âŒ æ’ä»¶å®ä¾‹æœªæ‰¾åˆ°', 'error');
                        }
                    } else {
                        log('âŒ æ’ä»¶æœªæ­£ç¡®æ³¨å†Œ', 'error');
                    }
                };
                script.onerror = () => {
                    log('âŒ æ’ä»¶è„šæœ¬åŠ è½½å¤±è´¥', 'error');
                };

                document.head.appendChild(script);
            } catch (error) {
                log(`âŒ åŠ è½½æ’ä»¶æ—¶å‡ºé”™: ${error.message}`, 'error');
            }
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            log('å¼€å§‹è¿è¡Œæ’ä»¶ç³»ç»Ÿæµ‹è¯•...', 'info');

            // ç­‰å¾…çŸ­æš‚æ—¶é—´è®©é¡µé¢åˆå§‹åŒ–
            await new Promise(resolve => setTimeout(resolve, 1000));

            // æµ‹è¯•å…¨å±€API
            const apiAvailable = testGlobalAPI();

            // æµ‹è¯•æ’ä»¶æ–‡ä»¶è®¿é—®
            const manifest = await testPluginManifest();
            const script = await testPluginScript();

            if (apiAvailable && manifest && script) {
                log('æ‰€æœ‰å‰ç½®æ¡ä»¶æ»¡è¶³ï¼Œå¼€å§‹åŠ è½½æ’ä»¶...', 'info');
                await loadTestPlugin();
            } else {
                log('âŒ å‰ç½®æ¡ä»¶ä¸æ»¡è¶³ï¼Œè·³è¿‡æ’ä»¶åŠ è½½', 'error');
            }

            log('æµ‹è¯•å®Œæˆ', 'info');
        }

        // é¡µé¢åŠ è½½åè¿è¡Œæµ‹è¯•
        window.addEventListener('load', runAllTests);

        // ç›‘å¬æ’ä»¶åŠ è½½äº‹ä»¶
        window.addEventListener('lifebox:dev-plugin:loaded', (event) => {
            log(`ğŸ“¡ æ”¶åˆ°æ’ä»¶åŠ è½½äº‹ä»¶: ${event.detail.plugin.name}`, 'success');
        });
    </script>
</body>
</html>